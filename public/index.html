<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Talkbox - Secure Message Exchange</title>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.4/dist/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    window.nostrToolsReady = import('https://esm.sh/nostr-tools@2.19.3').then(mod => {
      window.nostrTools = mod;
      return mod;
    });
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f8f8; min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
    .header { margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px; }
    .header h1 { font-size: 32px; color: #333; margin-bottom: 8px; }
    .header p { color: #666; font-size: 15px; line-height: 1.6; }
    .tabs { display: flex; gap: 5px; margin-bottom: 30px; border-bottom: 2px solid #ddd; }
    .tab { padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
    .tab:hover { color: #007bff; }
    .tab.active { color: #007bff; border-color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 6px; }
    input[type="text"], input[type="password"], textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: monospace; transition: border-color 0.15s; }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1); }
    textarea { resize: vertical; min-height: 80px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.15s; }
    button:hover { background: #0056b3; }
    button:active { background: #004085; }
    button.small { width: auto; padding: 6px 12px; font-size: 12px; margin-left: 8px; display: inline-block; }
    .result { padding: 16px; border-radius: 4px; margin-top: 20px; font-size: 14px; border-left: 4px solid #007bff; background: #e7f3ff; }
    .result.success { border-left-color: #28a745; background: #d4edda; color: #155724; }
    .result.error { border-left-color: #dc3545; background: #f8d7da; color: #721c24; }
    .result h3 { font-size: 15px; margin-bottom: 8px; font-weight: 600; }
    .shortcode-display { font-family: monospace; font-size: 16px; font-weight: bold; color: #007bff; padding: 12px; background: #f0f8ff; border-radius: 4px; word-break: break-all; margin: 12px 0; text-align: center; }
    .message-item { background: #f9f9f9; padding: 12px; margin-bottom: 12px; border-radius: 4px; border-left: 3px solid #007bff; }
    .message-text { color: #333; font-size: 14px; word-break: break-word; margin-bottom: 6px; }
    .message-time { color: #999; font-size: 12px; }
    .info { background: #e3f2fd; color: #1565c0; padding: 12px; border-radius: 4px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
    .shortcode-container { display: flex; gap: 16px; align-items: center; }
    .shortcode-visual { display: grid; grid-template-columns: repeat(16, 1fr); gap: 1px; padding: 8px; background: #ddd; border-radius: 4px; }
    .shortcode-visual.compact { grid-template-columns: repeat(8, 1fr); }
    .pixel { width: 8px; height: 8px; border-radius: 1px; }
    .shortcode-text-compact { font-family: monospace; font-size: 12px; color: #007bff; word-break: break-all; line-height: 1.4; }
    #scanner-container { display: none; margin-bottom: 20px; }
    #scanner-container.active { display: block; }
    #qr-reader { width: 100%; max-width: 100%; }
    .scan-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    .scan-buttons button { flex: 1; padding: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Talkbox</h1>
      <p>Send encrypted messages using public key cryptography. Only the recipient can read messages.</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('generate')">1. Generate</button>
      <button class="tab" onclick="switchTab('send')">2. Send</button>
      <button class="tab" onclick="switchTab('read')">3. Read</button>
    </div>

    <!-- Generate Tab -->
    <div id="generate" class="tab-content active">
      <div class="info">
        <strong>Step 1:</strong> Create a password. Your shortcode is derived from it instantly (100% client-side, no server interaction).
      </div>
      <div class="form-group">
        <label for="gen-password">Your Password</label>
        <input type="password" id="gen-password" placeholder="Make it strong" onkeyup="liveGenerateShortcode()">
      </div>
      <div id="gen-result"></div>
    </div>

    <!-- Send Tab -->
    <div id="send" class="tab-content">
      <div class="info">
        <strong>Step 2:</strong> Someone shares their shortcode. Send them an encrypted message (only they can read it with their password).
      </div>
      <div class="scan-buttons">
        <button onclick="toggleQRScanner()">ðŸ“· Scan QR Code</button>
        <button onclick="toggleQRScanner()" id="close-scanner-btn" style="display:none;">Close Scanner</button>
      </div>
      <div id="scanner-container">
        <div id="qr-reader"></div>
      </div>
      <div class="form-group">
        <label for="send-shortcode">Their Shortcode</label>
        <input type="text" id="send-shortcode" placeholder="Paste the shortcode they shared or scan QR">
      </div>
      <div class="form-group">
        <label for="send-message">Your Message</label>
        <textarea id="send-message" placeholder="What do you want to say?"></textarea>
      </div>
      <button onclick="sendMessage()">Send Message</button>
      <div id="send-result"></div>
    </div>

    <!-- Read Tab -->
    <div id="read" class="tab-content">
      <div class="info">
        <strong>Step 3:</strong> Enter your password to read all messages sent to you.
      </div>
      <div class="form-group">
        <label for="read-password">Your Password</label>
        <input type="password" id="read-password" placeholder="Your password" onkeyup="liveShowShortcode()">
      </div>
      <button onclick="readMessages()">Read Messages</button>
      <div id="read-result"></div>
    </div>
  </div>

  <script>
    console.log('Talkbox - 100% client-side, no backend needed');

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    }

    function toBase58(bytes) {
      const alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      let num = 0n;
      for (let i = 0; i < bytes.length; i++) {
        num = num * 256n + BigInt(bytes[i]);
      }
      if (num === 0n) return '1';
      let result = '';
      while (num > 0n) {
        result = alphabet[Number(num % 58n)] + result;
        num = num / 58n;
      }
      for (let i = 0; i < bytes.length; i++) {
        if (bytes[i] === 0) result = '1' + result;
        else break;
      }
      return result;
    }

    function fromBase58(str) {
      const alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      let num = 0n;
      for (let i = 0; i < str.length; i++) {
        const idx = alphabet.indexOf(str[i]);
        if (idx === -1) throw new Error('Invalid Base58 character');
        num = num * 58n + BigInt(idx);
      }
      const bytes = [];
      while (num > 0n) {
        bytes.unshift(Number(num & 0xFFn));
        num = num >> 8n;
      }
      for (let i = 0; i < str.length; i++) {
        if (str[i] === '1') bytes.unshift(0);
        else break;
      }
      return new Uint8Array(bytes.length === 0 ? [0] : bytes);
    }

    function generateVisualGrid(bytes, compact = true) {
      const cols = compact ? 8 : 16;
      const html = [];
      for (let i = 0; i < (compact ? 8 : 32); i++) {
        for (let j = 0; j < 8; j++) {
          const bit = (bytes[i] >> (7 - j)) & 1;
          html.push(`<div class="pixel" style="background: ${bit ? '#007bff' : '#f0f0f0'}"></div>`);
        }
      }
      return html.join('');
    }

    function createMicroQRCode(secretKeyBytes, base58Text) {
      try {
        const data = String.fromCharCode.apply(null, secretKeyBytes);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        new QRious({
          element: canvas,
          value: data,
          size: 100,
          level: 'H',
          mime: 'image/png'
        });

        return {
          dataUrl: canvas.toDataURL('image/png'),
          compact: btoa(data),
          full: base58Text,
          bytes: secretKeyBytes
        };
      } catch (e) {
        console.warn('QR generation failed:', e);
        return null;
      }
    }

    async function generateShortcodeFromPassword(password) {
      if (!password) return { hex: '', base58: '', visual: '', qr: null };

      // Wait for nostr-tools to be loaded
      let attempts = 0;
      while (!window.nostrTools && attempts < 100) {
        await new Promise(r => setTimeout(r, 10));
        attempts++;
      }

      if (!window.nostrTools) {
        console.error('Failed to load nostr-tools');
        return { hex: '', base58: '', visual: '', qr: null };
      }

      // Derive Nostr Ed25519 public key from password
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'talkbox-nostr-derivation');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const seed = new Uint8Array(hashBuffer);
      const secretKey = seed.slice(0, 32);
      const publicKey = window.nostrTools.getPublicKey(secretKey);

      const base58 = toBase58(secretKey);
      const visual = generateVisualGrid(secretKey, true);
      const qrData = createMicroQRCode(secretKey, base58);

      return { hex: publicKey, base58, visual, qr: qrData, bytes: secretKey };
    }

    async function deriveKeypair(password) {
      // For encryption, use NaCl with hash as seed
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const seed = new Uint8Array(hashBuffer);
      const keypair = nacl.box.keyPair.fromSecretKey(seed.slice(0, 32));
      return keypair;
    }

    async function liveGenerateShortcode() {
      const password = document.getElementById('gen-password').value;
      if (!password) {
        document.getElementById('gen-result').innerHTML = '';
        return;
      }
      const result = await generateShortcodeFromPassword(password);
      const qrImg = result.qr && result.qr.dataUrl ? `<img src="${result.qr.dataUrl}" style="max-width: 120px; border: 1px solid #ddd; border-radius: 4px;" alt="MicroQR" title="Raw 32-byte binary"/>` : '';
      const html = `
        <div class="result success">
          <h3>âœ“ Your Shortcode (Generated Instantly)</h3>
          <div style="display: flex; gap: 20px; align-items: flex-start;">
            <div style="text-align: center;">
              ${qrImg}
              <div style="font-size: 10px; color: #999; margin-top: 8px;">Binary QR<br>(32 bytes)</div>
            </div>
            <div style="flex: 1;">
              <div class="shortcode-text-compact" style="margin-bottom: 8px;"><strong>Share this Base58:</strong><br>${result.base58}</div>
              <button class="small" onclick="copyToClipboard('${result.qr?.compact}')">Copy Base64</button>
              <button class="small" onclick="copyToClipboard('${result.base58}')">Copy Base58</button>
            </div>
          </div>
          <span style="color: #666; font-size: 12px; margin-top: 12px; display: block;">ðŸ“± QR encodes raw 32-byte key directly. Scan with camera to auto-fill shortcode.</span>
        </div>
      `;
      document.getElementById('gen-result').innerHTML = html;
    }

    async function liveShowShortcode() {
      const password = document.getElementById('read-password').value;
      if (!password) return;
      const shortcode = await generateShortcodeFromPassword(password);
      console.log('Your shortcode:', shortcode);
    }

    async function sendMessage() {
      let shortcodeInput = document.getElementById('send-shortcode').value.trim();
      const message = document.getElementById('send-message').value;
      if (!shortcodeInput || !message) {
        showResult('send-result', 'Please enter shortcode and message', 'error');
        return;
      }
      try {
        showResult('send-result', 'Publishing to Nostr relays...', 'success');

        await window.nostrToolsReady;
        const relays = ['wss://relay.damus.io', 'wss://nos.lol', 'wss://nostr.wine', 'wss://relay.nostr.band'];
        const pool = new window.nostrTools.SimplePool();

        const senderPassword = 'talkbox-sender-' + Math.random();
        const senderSecret = await deriveSecret(senderPassword);
        const senderPubkey = window.nostrTools.getPublicKey(senderSecret);

        let recipientSecretBytes;
        try {
          if (/^[A-Za-z0-9+/=]+$/.test(shortcodeInput)) {
            const binaryString = atob(shortcodeInput);
            recipientSecretBytes = new Uint8Array(binaryString.split('').map(c => c.charCodeAt(0)));
          } else {
            recipientSecretBytes = fromBase58(shortcodeInput);
          }
        } catch (e) {
          recipientSecretBytes = fromBase58(shortcodeInput);
        }
        if (!recipientSecretBytes || recipientSecretBytes.length !== 32) {
          showResult('send-result', 'Invalid shortcode format', 'error');
          return;
        }
        const recipientPubkey = window.nostrTools.getPublicKey(recipientSecretBytes);

        const event = window.nostrTools.finalizeEvent({
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['p', recipientPubkey]],
          content: message,
          pubkey: senderPubkey
        }, senderSecret);

        const publishPromises = relays.map(async r => {
          try {
            const pubs = pool.publish([r], event);
            let published = false;
            for await (const pub of pubs) {
              published = true;
            }
            return published;
          } catch (e) {
            console.error('Publish error:', e);
            return false;
          }
        });

        const results = await Promise.all(publishPromises);
        await new Promise(r => setTimeout(r, 500));
        pool.close(relays);

        document.getElementById('send-message').value = '';
        showResult('send-result', 'âœ“ Message sent successfully!', 'success');
      } catch (e) {
        showResult('send-result', 'Error: ' + e.message, 'error');
      }
    }

    async function deriveSecret(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'talkbox-nostr-derivation');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hashBuffer).slice(0, 32);
    }

    async function readMessages() {
      const password = document.getElementById('read-password').value;
      if (!password) {
        showResult('read-result', 'Please enter your password', 'error');
        return;
      }
      try {
        showResult('read-result', 'Querying Nostr relays...', 'success');

        await window.nostrToolsReady;
        const result = await generateShortcodeFromPassword(password);
        const shortcode = result.hex;
        const relays = ['wss://relay.damus.io', 'wss://nos.lol', 'wss://nostr.wine', 'wss://relay.nostr.band'];
        const pool = new window.nostrTools.SimplePool();

        const filter = {
          kinds: [1],
          '#p': [shortcode],
          limit: 100
        };

        const events = await pool.querySync(relays, filter, { timeout: 5000 });
        pool.close(relays);

        const messages = events
          .sort((a, b) => b.created_at - a.created_at)
          .map(e => ({
            message: e.content,
            timestamp: e.created_at * 1000
          }));

        if (messages.length === 0) {
          const qrImg = result.qr && result.qr.dataUrl ? `<img src="${result.qr.dataUrl}" style="max-width: 100px; border: 1px solid #ddd; border-radius: 4px;" alt="QR Code"/>` : '';
          showResult('read-result', `<h3>No messages yet</h3><strong>Your shortcode to share:</strong><div style="margin-top: 12px; display: flex; gap: 12px;"><div style="text-align: center;">${qrImg}</div><div><div class="shortcode-text-compact"><strong>Base58:</strong><br>${result.base58}</div></div></div>`, 'success');
        } else {
          let html = `<h3>ðŸ“¨ Messages (${messages.length})</h3>`;
          messages.forEach(msg => {
            const time = new Date(msg.timestamp).toLocaleString();
            html += `<div class="message-item"><div class="message-text">${escapeHtml(msg.message)}</div><div class="message-time">${time}</div></div>`;
          });
          document.getElementById('read-result').innerHTML = `<div class="result success">${html}</div>`;
        }
      } catch (e) {
        showResult('read-result', 'Error: ' + e.message, 'error');
      }
    }

    function showResult(elementId, message, type) {
      const resultDiv = document.getElementById(elementId);
      resultDiv.innerHTML = `<div class="result ${type}"><h3>${type === 'error' ? 'âš ' : 'âœ“'}</h3>${message}</div>`;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied!');
      });
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    let qrScanner = null;
    let isScannerRunning = false;

    function toggleQRScanner() {
      const scannerContainer = document.getElementById('scanner-container');
      const scanBtn = document.querySelector('.scan-buttons button:first-child');
      const closeBtn = document.getElementById('close-scanner-btn');

      if (isScannerRunning) {
        stopQRScanner();
        scannerContainer.classList.remove('active');
        scanBtn.style.display = 'block';
        closeBtn.style.display = 'none';
        isScannerRunning = false;
      } else {
        startQRScanner();
        scannerContainer.classList.add('active');
        scanBtn.style.display = 'none';
        closeBtn.style.display = 'block';
        isScannerRunning = true;
      }
    }

    function startQRScanner() {
      qrScanner = new Html5Qrcode('qr-reader');
      qrScanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        onQRScan,
        onScanError
      ).catch(e => console.error('Failed to start scanner:', e));
    }

    function stopQRScanner() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          qrScanner.clear();
          qrScanner = null;
        }).catch(e => console.error('Failed to stop scanner:', e));
      }
    }

    function onQRScan(decodedText) {
      const cleanedText = decodedText.trim();
      document.getElementById('send-shortcode').value = cleanedText;
      toggleQRScanner();
      showResult('send-result', 'âœ“ QR code scanned successfully!', 'success');
    }

    function onScanError(errorMessage) {
    }
  </script>
</body>
</html>
