<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Talkbox - Secure Message Exchange</title>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f8f8; min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
    .header { margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px; }
    .header h1 { font-size: 32px; color: #333; margin-bottom: 8px; }
    .header p { color: #666; font-size: 15px; line-height: 1.6; }
    .tabs { display: flex; gap: 5px; margin-bottom: 30px; border-bottom: 2px solid #ddd; }
    .tab { padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
    .tab:hover { color: #007bff; }
    .tab.active { color: #007bff; border-color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 6px; }
    input[type="text"], input[type="password"], textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: monospace; transition: border-color 0.15s; }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1); }
    textarea { resize: vertical; min-height: 80px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.15s; }
    button:hover { background: #0056b3; }
    button:active { background: #004085; }
    button.small { width: auto; padding: 6px 12px; font-size: 12px; margin-left: 8px; display: inline-block; }
    .result { padding: 16px; border-radius: 4px; margin-top: 20px; font-size: 14px; border-left: 4px solid #007bff; background: #e7f3ff; }
    .result.success { border-left-color: #28a745; background: #d4edda; color: #155724; }
    .result.error { border-left-color: #dc3545; background: #f8d7da; color: #721c24; }
    .result h3 { font-size: 15px; margin-bottom: 8px; font-weight: 600; }
    .shortcode-display { font-family: monospace; font-size: 16px; font-weight: bold; color: #007bff; padding: 12px; background: #f0f8ff; border-radius: 4px; word-break: break-all; margin: 12px 0; text-align: center; }
    .message-item { background: #f9f9f9; padding: 12px; margin-bottom: 12px; border-radius: 4px; border-left: 3px solid #007bff; }
    .message-text { color: #333; font-size: 14px; word-break: break-word; margin-bottom: 6px; }
    .message-time { color: #999; font-size: 12px; }
    .info { background: #e3f2fd; color: #1565c0; padding: 12px; border-radius: 4px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Talkbox</h1>
      <p>Send encrypted messages using public key cryptography. Only the recipient can read messages.</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('generate')">1. Generate</button>
      <button class="tab" onclick="switchTab('send')">2. Send</button>
      <button class="tab" onclick="switchTab('read')">3. Read</button>
    </div>

    <!-- Generate Tab -->
    <div id="generate" class="tab-content active">
      <div class="info">
        <strong>Step 1:</strong> Create a password. Your shortcode is derived from it instantly (100% client-side, no server interaction).
      </div>
      <div class="form-group">
        <label for="gen-password">Your Password</label>
        <input type="password" id="gen-password" placeholder="Make it strong" onkeyup="liveGenerateShortcode()">
      </div>
      <div id="gen-result"></div>
    </div>

    <!-- Send Tab -->
    <div id="send" class="tab-content">
      <div class="info">
        <strong>Step 2:</strong> Someone shares their shortcode. Send them an encrypted message (only they can read it with their password).
      </div>
      <div class="form-group">
        <label for="send-shortcode">Their Shortcode</label>
        <input type="text" id="send-shortcode" placeholder="Paste the shortcode they shared">
      </div>
      <div class="form-group">
        <label for="send-message">Your Message</label>
        <textarea id="send-message" placeholder="What do you want to say?"></textarea>
      </div>
      <button onclick="sendMessage()">Send Message</button>
      <div id="send-result"></div>
    </div>

    <!-- Read Tab -->
    <div id="read" class="tab-content">
      <div class="info">
        <strong>Step 3:</strong> Enter your password to read all messages sent to you.
      </div>
      <div class="form-group">
        <label for="read-password">Your Password</label>
        <input type="password" id="read-password" placeholder="Your password" onkeyup="liveShowShortcode()">
      </div>
      <button onclick="readMessages()">Read Messages</button>
      <div id="read-result"></div>
    </div>
  </div>

  <script>
    let API_URL = window.location.origin;

    // Check URL parameters first (highest priority)
    const params = new URLSearchParams(window.location.search);
    if (params.has('api')) {
      API_URL = params.get('api');
    } else if (window.location.hostname.includes('github.io')) {
      // For GitHub Pages, use Cloudflare Workers
      API_URL = 'https://talkbox.almagestfraternite.workers.dev';
    } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      // For localhost development
      API_URL = 'http://localhost:8000';
    }
    console.log('API URL:', API_URL);

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    }

    async function deriveKeypair(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const seed = new Uint8Array(hashBuffer);
      const keypair = nacl.box.keyPair.fromSecretKey(seed.slice(0, 32));
      return keypair;
    }

    async function generateShortcodeFromPassword(password) {
      if (!password) return '';
      const keypair = await deriveKeypair(password);
      const publicKeyBase64 = btoa(String.fromCharCode(...keypair.publicKey));
      return publicKeyBase64.substring(0, 16);
    }

    async function liveGenerateShortcode() {
      const password = document.getElementById('gen-password').value;
      if (!password) {
        document.getElementById('gen-result').innerHTML = '';
        return;
      }
      const shortcode = await generateShortcodeFromPassword(password);
      const html = `
        <div class="result success">
          <h3>âœ“ Your Shortcode (Generated Instantly)</h3>
          <div class="shortcode-display">${shortcode}</div>
          <button class="small" onclick="copyToClipboard('${shortcode}')">Copy</button>
          <span style="color: #666; font-size: 13px; margin-left: 8px;">Share this with others</span>
        </div>
      `;
      document.getElementById('gen-result').innerHTML = html;
    }

    async function liveShowShortcode() {
      const password = document.getElementById('read-password').value;
      if (!password) return;
      const shortcode = await generateShortcodeFromPassword(password);
      console.log('Your shortcode:', shortcode);
    }

    async function sendMessage() {
      const shortcode = document.getElementById('send-shortcode').value;
      const message = document.getElementById('send-message').value;
      if (!shortcode || !message) {
        showResult('send-result', 'Please enter shortcode and message', 'error');
        return;
      }
      try {
        const response = await fetch(`${API_URL}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ shortcode, message })
        });
        const data = await response.json();
        if (data.success) {
          document.getElementById('send-message').value = '';
          showResult('send-result', 'âœ“ Message sent successfully!', 'success');
        } else {
          showResult('send-result', 'Error: ' + (data.error || 'Failed to send'), 'error');
        }
      } catch (e) {
        showResult('send-result', 'Error: ' + e.message, 'error');
      }
    }

    async function readMessages() {
      const password = document.getElementById('read-password').value;
      if (!password) {
        showResult('read-result', 'Please enter your password', 'error');
        return;
      }
      try {
        const shortcode = await generateShortcodeFromPassword(password);
        const response = await fetch(`${API_URL}/read?password=${encodeURIComponent(password)}`);
        const data = await response.json();
        if (data.success) {
          if (data.messages.length === 0) {
            showResult('read-result', `<h3>No messages yet</h3>Your shortcode to share: <div class="shortcode-display">${shortcode}</div>`, 'success');
          } else {
            let html = `<h3>ðŸ“¨ Messages (${data.messages.length})</h3>`;
            data.messages.forEach(msg => {
              const time = new Date(msg.timestamp).toLocaleString();
              html += `<div class="message-item"><div class="message-text">${escapeHtml(msg.message)}</div><div class="message-time">${time}</div></div>`;
            });
            document.getElementById('read-result').innerHTML = `<div class="result success">${html}</div>`;
          }
        } else {
          showResult('read-result', 'Error: ' + (data.error || 'Failed to read'), 'error');
        }
      } catch (e) {
        showResult('read-result', 'Error: ' + e.message, 'error');
      }
    }

    function showResult(elementId, message, type) {
      const resultDiv = document.getElementById(elementId);
      resultDiv.innerHTML = `<div class="result ${type}"><h3>${type === 'error' ? 'âš ' : 'âœ“'}</h3>${message}</div>`;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied!');
      });
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
  </script>
</body>
</html>
