<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Talkbox - Secure Message Exchange</title>
  <script src="nacl-fast.min.js"></script>
  <script src="qrcode.min.js"></script>
  <script src="jsqr.js"></script>
  <script src="base32.js"></script>
  <script src="nostr-tools.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #fafafa;
      min-height: 100vh;
      padding: 12px;
      color: #333;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .header p {
      color: #666;
      font-size: 15px;
      line-height: 1.6;
    }

    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 28px;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      flex: 1;
      padding: 16px 12px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      color: #999;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      min-width: fit-content;
      touch-action: manipulation;
    }

    .tab:active {
      color: #0066cc;
    }

    .tab.active {
      color: #0066cc;
      border-color: #0066cc;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 22px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #222;
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      font-family: monospace;
      background: #fff;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      outline: none;
      border-color: #0066cc;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 110px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.5;
    }

    button {
      width: 100%;
      padding: 16px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      touch-action: manipulation;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:active {
      background: #0052a3;
    }

    button.small {
      width: 100%;
      margin-top: 10px;
      padding: 14px;
      font-size: 15px;
    }

    .result {
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
      border-left: 4px solid #0066cc;
      background: #e6f0ff;
      color: #0066cc;
      line-height: 1.6;
    }

    .result.success {
      border-left-color: #28a745;
      background: #d4edda;
      color: #155724;
    }

    .result.error {
      border-left-color: #dc3545;
      background: #f8d7da;
      color: #721c24;
    }

    .result h3 {
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .shortcode-display {
      font-family: monospace;
      font-size: 14px;
      font-weight: bold;
      color: #0066cc;
      padding: 12px;
      background: #e6f0ff;
      border-radius: 4px;
      word-break: break-all;
      margin: 12px 0;
      text-align: center;
    }

    .message-item {
      background: #fff;
      padding: 14px;
      margin-bottom: 12px;
      border-radius: 8px;
      border-left: 4px solid #0066cc;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .message-text {
      color: #333;
      font-size: 15px;
      word-break: break-word;
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .message-time {
      color: #999;
      font-size: 13px;
    }

    .info {
      background: #e6f0ff;
      color: #0052a3;
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
    }

    .shortcode-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .shortcode-visual {
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      gap: 1px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .shortcode-visual.compact {
      grid-template-columns: repeat(8, 1fr);
    }

    .pixel {
      width: 6px;
      height: 6px;
    }

    .shortcode-text-compact {
      font-family: monospace;
      font-size: 13px;
      color: #0066cc;
      word-break: break-all;
      line-height: 1.5;
    }

    .shortcode-link {
      font-variant: small-caps;
      text-decoration: none;
      color: #0066cc;
      font-weight: 600;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Talkbox</h1>
      <p>Send encrypted messages using public key cryptography. Only the recipient can read messages.</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('generate')">1. Generate</button>
      <button class="tab" onclick="switchTab('send')">2. Send</button>
      <button class="tab" onclick="switchTab('read')">3. Read</button>
      <button class="tab" style="color: #d63384;" onclick="switchTab('terminal')">âš¡ Terminal</button>
    </div>

    <!-- Generate Tab -->
    <div id="generate" class="tab-content active">
      <div class="info">
        <strong>Step 1:</strong> Create a password. Your shortcode is derived from it instantly (100% client-side, no
        server interaction).
      </div>
      <div class="form-group">
        <label for="gen-password">Your Password</label>
        <input type="password" id="gen-password" placeholder="Make it strong" onkeyup="liveGenerateShortcode()">
      </div>
      <div id="gen-result"></div>
    </div>

    <!-- Send Tab -->
    <div id="send" class="tab-content">
      <div class="info">
        <strong>Step 2:</strong> Someone shares their shortcode. Send them an encrypted message (only they can read it
        with their password).
      </div>
      <div class="form-group">
        <label for="send-shortcode">Their Shortcode</label>
        <input type="text" id="send-shortcode" placeholder="Paste the shortcode they shared or scan QR">
        <button class="small" onclick="toggleQRScanner()">ðŸ“± Scan QR</button>
      </div>
      <div id="scanner-container" style="display: none; margin-bottom: 20px;">
        <video id="qr-video" autoplay playsinline muted
          style="width: 100%; border-radius: 4px; margin-bottom: 10px;"></video>
        <button onclick="stopQRScanner()" style="width: 100%;">Stop Scanner</button>
      </div>
      <div class="form-group">
        <label for="send-message">Your Message</label>
        <textarea id="send-message" placeholder="What do you want to say?"></textarea>
      </div>
      <button onclick="sendMessage()">Send Message</button>
      <div id="send-result"></div>
    </div>

    <!-- Read Tab -->
    <div id="read" class="tab-content">
      <div class="info">
        <strong>Step 3:</strong> Enter your password to read all messages sent to you.
      </div>
      <div class="form-group">
        <label for="read-password">Your Password</label>
        <input type="password" id="read-password" placeholder="Your password" onkeyup="liveShowShortcode()">
      </div>
      <button onclick="readMessages()">Read Messages</button>
      <div id="read-result"></div>
    </div>

    <!-- Terminal Tab -->
    <div id="terminal" class="tab-content"
      style="background: #000; color: #00ff00; padding: 20px; border-radius: 8px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; height: 600px; display: none; overflow: hidden; flex-direction: column; border: 1px solid #333;">
      <div style="margin-bottom: 20px;">
        <div style="font-size: 14px; font-weight: bold; margin-bottom: 12px; letter-spacing: 1px;">&gt; TALKBOX VIRTUAL
          TERMINAL (XTERM.JS)</div>
        <div
          style="display: flex; gap: 10px; align-items: center; background: #111; padding: 10px; border-radius: 4px; border: 1px solid #222;">
          <span style="font-size: 12px; color: #888;">PASS:</span>
          <input type="password" id="term-password"
            style="background: #000; color: #00ff00; border: 1px solid #444; flex: 1; padding: 5px 10px; border-radius: 2px; font-family: inherit;"
            placeholder="terminal secret">
          <button onclick="connectTerminal()"
            style="background: #009900; color: #fff; border: none; padding: 6px 15px; cursor: pointer; border-radius: 2px; font-size: 12px; width: auto; font-weight: bold;">CONNECT</button>
        </div>
      </div>

      <div id="xterm-container"
        style="flex: 1; background: #000; border-radius: 4px; overflow: hidden; border: 1px solid #222;"></div>
    </div>
  </div>

  <script>
    console.log('Talkbox - 100% client-side, no backend needed');

    const RELAYS = [
      'wss://relay.damus.io',
      'wss://nos.lol',
      'wss://nostr.wine',
      'wss://relay.nostr.band',
      'wss://nostr-pub.wellorder.net',
      'wss://relay.snort.social',
      'wss://nostr.mom',
      'wss://relay.current.fyi'
    ];

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    }

    function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (code) {
        document.getElementById('send-shortcode').value = code;
        switchTab('send');
        const sendTab = document.querySelector('.tab[onclick*="send"]');
        if (sendTab) sendTab.classList.add('active');
      }
    }

    window.addEventListener('DOMContentLoaded', initFromUrl);

    function toBase32(bytes) {
      return base32.encode(bytes).replace(/=/g, '');
    }

    function fromBase32(str) {
      return new Uint8Array(base32.decode.asBytes(str));
    }

    function generateVisualGrid(bytes, compact = true) {
      const cols = compact ? 8 : 16;
      const html = [];
      for (let i = 0; i < (compact ? 8 : 32); i++) {
        for (let j = 0; j < 8; j++) {
          const bit = (bytes[i] >> (7 - j)) & 1;
          html.push(`<div class="pixel" style="background: ${bit ? '#007bff' : '#f0f0f0'}"></div>`);
        }
      }
      return html.join('');
    }

    function createQRCode(urlText) {
      try {
        console.log('createQRCode input:', urlText);
        console.log('Input length:', urlText.length);

        const container = document.createElement('div');
        const qr = new QRCode(container, {
          text: urlText,
          width: 140,
          height: 140,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });

        const canvas = container.querySelector('canvas');
        if (canvas) {
          console.log('QR generated as canvas');
          return canvas.toDataURL('image/png');
        }

        const img = container.querySelector('img');
        if (img) {
          console.log('QR generated as img');
          return img.src;
        }

        return null;
      } catch (e) {
        console.warn('QR generation failed:', e);
        return null;
      }
    }

    async function generateShortcodeFromPassword(password) {
      if (!password) return { hex: '', base58: '', visual: '', qr: null };
      if (!window.nostrTools) {
        console.error('nostr-tools not loaded');
        return { hex: '', base58: '', visual: '', qr: null };
      }

      // Derive Nostr Ed25519 public key from password
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'talkbox-nostr-derivation');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const seed = new Uint8Array(hashBuffer);
      const secretKey = seed.slice(0, 32);
      const publicKey = window.nostrTools.getPublicKey(secretKey);

      const shortcode = toBase32(secretKey);
      const visual = generateVisualGrid(secretKey, true);

      return { hex: publicKey, base58: shortcode, visual, bytes: secretKey };
    }

    async function deriveKeypair(password) {
      // For encryption, use NaCl with hash as seed
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const seed = new Uint8Array(hashBuffer);
      const keypair = nacl.box.keyPair.fromSecretKey(seed.slice(0, 32));
      return keypair;
    }

    async function liveGenerateShortcode() {
      const password = document.getElementById('gen-password').value;
      if (!password) {
        document.getElementById('gen-result').innerHTML = '';
        return;
      }
      const result = await generateShortcodeFromPassword(password);
      const shareUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?code=${encodeURIComponent(result.base58)}`;
      console.log('ðŸ“± QR encoding full URL:', shareUrl);
      const qrDataUrl = createQRCode(shareUrl);
      const qrImg = qrDataUrl ? `<img src="${qrDataUrl}" style="max-width: 140px; border: 1px solid #ddd; border-radius: 8px;" alt="QR Code"/>` : '';
      const html = `
        <div class="result success">
          <h3>âœ“ Your Shortcode</h3>
          <div style="text-align: center; margin-bottom: 16px;">
            ${qrImg}
            <div style="font-size: 12px; color: #666; margin-top: 12px;">Share QR Code or text below</div>
          </div>
          <div style="margin-bottom: 14px; word-break: break-all;">
            <a href="${shareUrl}" class="shortcode-link" style="font-size: 14px; display: inline-block; max-width: 100%;">${result.base58}</a>
          </div>
          <div style="font-size: 11px; color: #999; word-break: break-all; background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 12px;">QR encodes: ${shareUrl}</div>
          <button class="small" onclick="copyToClipboard('${result.base58}')">ðŸ“‹ Copy Shortcode</button>
        </div>
      `;
      document.getElementById('gen-result').innerHTML = html;
    }

    async function liveShowShortcode() {
      const password = document.getElementById('read-password').value;
      if (!password) return;
      const shortcode = await generateShortcodeFromPassword(password);
      console.log('Your shortcode:', shortcode);
    }

    async function sendMessage() {
      let shortcodeInput = document.getElementById('send-shortcode').value.trim();
      const message = document.getElementById('send-message').value;
      if (!shortcodeInput || !message) {
        showResult('send-result', 'Please enter shortcode and message', 'error');
        return;
      }
      try {
        showResult('send-result', 'Publishing to Nostr relays...', 'success');

        const pool = new window.nostrTools.SimplePool();

        const senderPassword = 'talkbox-sender-' + Math.random();
        const senderSecret = await deriveSecret(senderPassword);
        const senderPubkey = window.nostrTools.getPublicKey(senderSecret);

        let recipientSecretBytes;
        if (shortcodeInput.length === 32 && /[\x00-\x1F\x7F-\xFF]/.test(shortcodeInput)) {
          recipientSecretBytes = new Uint8Array(shortcodeInput.split('').map(c => c.charCodeAt(0)));
        } else {
          try {
            recipientSecretBytes = fromBase32(shortcodeInput);
          } catch (e) {
            showResult('send-result', 'Invalid shortcode format', 'error');
            return;
          }
        }
        if (!recipientSecretBytes || recipientSecretBytes.length !== 32) {
          showResult('send-result', 'Invalid shortcode format', 'error');
          return;
        }
        const recipientPubkey = window.nostrTools.getPublicKey(recipientSecretBytes);

        const event = window.nostrTools.finalizeEvent({
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['p', recipientPubkey]],
          content: message,
          pubkey: senderPubkey
        }, senderSecret);

        const publishPromises = RELAYS.map(async r => {
          try {
            const pubs = pool.publish([r], event);
            let published = false;
            for await (const pub of pubs) {
              published = true;
            }
            return published;
          } catch (e) {
            console.error('Publish error:', e);
            return false;
          }
        });

        const results = await Promise.all(publishPromises);
        await new Promise(r => setTimeout(r, 500));
        pool.close(RELAYS);

        document.getElementById('send-message').value = '';
        showResult('send-result', 'âœ“ Message sent successfully!', 'success');
      } catch (e) {
        showResult('send-result', 'Error: ' + e.message, 'error');
      }
    }

    async function deriveSecret(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'talkbox-nostr-derivation');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hashBuffer).slice(0, 32);
    }

    async function readMessages() {
      const password = document.getElementById('read-password').value;
      if (!password) {
        showResult('read-result', 'Please enter your password', 'error');
        return;
      }
      try {
        showResult('read-result', 'Querying Nostr relays...', 'success');

        const result = await generateShortcodeFromPassword(password);
        const shortcode = result.hex;
        const pool = new window.nostrTools.SimplePool();

        const filter = {
          kinds: [1],
          '#p': [shortcode],
          limit: 100
        };

        const events = await pool.querySync(RELAYS, filter, { timeout: 5000 });
        pool.close(RELAYS);

        const messages = events
          .sort((a, b) => b.created_at - a.created_at)
          .map(e => ({
            message: e.content,
            timestamp: e.created_at * 1000
          }));

        if (messages.length === 0) {
          const qrImg = result.qr && result.qr.dataUrl ? `<img src="${result.qr.dataUrl}" style="max-width: 100px; border: 1px solid #ddd; border-radius: 4px;" alt="QR Code"/>` : '';
          showResult('read-result', `<h3>No messages yet</h3><strong>Your shortcode to share:</strong><div style="margin-top: 12px; display: flex; gap: 12px;"><div style="text-align: center;">${qrImg}</div><div><div class="shortcode-text-compact"><strong>Base58:</strong><br>${result.base58}</div></div></div>`, 'success');
        } else {
          let html = `<h3>ðŸ“¨ Messages (${messages.length})</h3>`;
          messages.forEach(msg => {
            const time = new Date(msg.timestamp).toLocaleString();
            html += `<div class="message-item"><div class="message-text">${escapeHtml(msg.message)}</div><div class="message-time">${time}</div></div>`;
          });
          document.getElementById('read-result').innerHTML = `<div class="result success">${html}</div>`;
        }
      } catch (e) {
        showResult('read-result', 'Error: ' + e.message, 'error');
      }
    }

    function showResult(elementId, message, type) {
      const resultDiv = document.getElementById(elementId);
      resultDiv.innerHTML = `<div class="result ${type}"><h3>${type === 'error' ? 'âš ' : 'âœ“'}</h3>${message}</div>`;
    }

    // --- Terminal Logic (Xterm.js) ---
    let termPool = null;
    let termSub = null;
    let termTopicKeys = null;
    let xterm = null;

    async function connectTerminal() {
      const password = document.getElementById('term-password').value;
      if (!password) return alert('Enter password');

      if (!xterm) {
        xterm = new Terminal({
          cursorBlink: true,
          theme: {
            background: '#000000',
            foreground: '#00ff00',
            cursor: '#00ff00'
          },
          fontFamily: 'Consolas, "Liberation Mono", Courier, monospace',
          fontSize: 14
        });
        xterm.open(document.getElementById('xterm-container'));

        xterm.onData(data => {
          sendTermInput(data);
        });
      }

      xterm.write('\x1b[32m[SYSTEM] Connecting to Nostr relays...\x1b[0m\r\n');

      try {
        if (termPool) termPool.close(RELAYS);
        termPool = new window.NostrTools.SimplePool();

        const terminalUrl = `terminal://talkbox-v1/${password}`;
        const encoder = new TextEncoder();
        const data = encoder.encode(terminalUrl + 'talkbox-comments-v1');
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const secret = new Uint8Array(hashBuffer);
        const pubkey = window.NostrTools.getPublicKey(secret);
        const conversationKey = window.NostrTools.nip44.getConversationKey(secret, pubkey);

        termTopicKeys = { secret, pubkey, conversationKey };

        xterm.write(`\x1b[32m[SYSTEM] Identity derived: ${pubkey.substring(0, 8)}...\x1b[0m\r\n`);

        termSub = termPool.subscribeMany(RELAYS, {
          kinds: [20002],
          '#p': [pubkey],
          since: Math.floor(Date.now() / 1000)
        }, {
          onevent(event) {
            try {
              const decrypted = window.NostrTools.nip44.decrypt(event.content, termTopicKeys.conversationKey);
              xterm.write(decrypted);
            } catch (e) {
              console.error('Decryption failed', e);
            }
          }
        });

        xterm.write('\x1b[32m[SYSTEM] Link Established. Streaming session active.\x1b[0m\r\n\r\n');
      } catch (e) {
        xterm.write(`\x1b[31m[ERROR] ${e.message}\x1b[0m\r\n`);
      }
    }

    async function sendTermInput(input) {
      if (!termTopicKeys || !termPool) return;

      try {
        const encrypted = window.NostrTools.nip44.encrypt(input, termTopicKeys.conversationKey);
        const event = window.NostrTools.finalizeEvent({
          kind: 20001,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['p', termTopicKeys.pubkey], ['encrypted', 'nip44']],
          content: encrypted,
          pubkey: termTopicKeys.pubkey
        }, termTopicKeys.secret);

        const pubs = termPool.publish(RELAYS, event);
        // Fire and forget for inputs to keep latency low
      } catch (e) {
        console.error('Send error:', e);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied!');
      });
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    let scannerStream = null;

    async function toggleQRScanner() {
      const container = document.getElementById('scanner-container');
      if (container.style.display === 'none') {
        await startQRScanner();
        container.style.display = 'block';
      } else {
        stopQRScanner();
        container.style.display = 'none';
      }
    }

    async function startQRScanner() {
      const video = document.getElementById('qr-video');
      try {
        scannerStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = scannerStream;
        await video.play();
        scanQRFrame(video);
      } catch (e) {
        console.error('Camera error:', e.name, e.message);
        const msg = e.name === 'NotAllowedError'
          ? 'Camera permission denied. Allow camera access in browser settings.'
          : e.name === 'NotFoundError'
            ? 'No camera found on this device.'
            : 'Camera error: ' + e.message;
        showResult('send-result', msg, 'error');
      }
    }

    function stopQRScanner() {
      document.getElementById('scanner-container').style.display = 'none';
      if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
      }
    }

    function scanQRFrame(video) {
      if (!scannerStream) return;

      if (!video.videoWidth || !video.videoHeight) {
        requestAnimationFrame(() => scanQRFrame(video));
        return;
      }

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      ctx.drawImage(video, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code) {
        try {
          const qrText = code.data;
          let shortcode = null;

          if (qrText.includes('?code=')) {
            const url = new URL(qrText);
            shortcode = url.searchParams.get('code');
          } else if (qrText.length > 50) {
            showResult('send-result', 'Invalid QR: not a shortcode link', 'error');
            requestAnimationFrame(() => scanQRFrame(video));
            return;
          } else {
            shortcode = qrText;
          }

          if (!shortcode || shortcode.length < 32) {
            showResult('send-result', 'Invalid QR: shortcode too short', 'error');
            requestAnimationFrame(() => scanQRFrame(video));
            return;
          }

          document.getElementById('send-shortcode').value = shortcode;
          stopQRScanner();
          showResult('send-result', 'âœ“ QR scanned: ' + shortcode.substring(0, 8) + '...', 'success');
        } catch (e) {
          console.error('Scan error:', e.message);
          showResult('send-result', 'Failed to scan QR: ' + e.message, 'error');
          requestAnimationFrame(() => scanQRFrame(video));
        }
      } else {
        requestAnimationFrame(() => scanQRFrame(video));
      }
    }

  </script>
</body>

</html>